<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Coimbatore Food & Restaurant Recommender</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {font-family:Arial, sans-serif; background:#12171f; color:#f2f5f9; margin:0;}
    .container {max-width:1100px; margin:24px auto; display:flex; gap:24px; flex-wrap:wrap;}
    .panel {background:#1d2530; padding:18px 22px; border-radius:12px; flex:1; min-width:320px;}
    .chat-panel {flex:2; display:flex; flex-direction:column;}
    h2 {margin-top:0;}
    input,button,textarea {border:none; outline:none; border-radius:6px; padding:10px; font-size:14px;}
    input,textarea {background:#2a3342; color:#fff; width:100%; margin-bottom:10px;}
    button {background:#4fb070; color:#fff; cursor:pointer; font-weight:600;}
    button:hover {background:#3d945a;}
    #chatBox {background:#182029; flex:1; padding:16px; border-radius:10px; overflow-y:auto; min-height:420px;}
    .msg {margin:10px 0; line-height:1.4;}
    .user {color:#7fd1b9; text-align:right;}
    .bot {color:#e6c273; text-align:left;}
    .feedback-row {margin-top:10px;}
    .small {font-size:12px; color:#8899aa; margin-top:4px;}
  </style>
</head>
<body>
<div class="container">
  <div class="panel" style="max-width:340px">
    <h2>Account</h2>
    <div id="authBox">
      <input id="email" placeholder="Email"/>
      <input id="pwd" type="password" placeholder="Password"/>
      <button onclick="signup()">Signup</button>
      <button onclick="login()">Login</button>
      <div id="authMsg" class="small"></div>
    </div>
    <div id="profileBox" style="display:none;">
      <div>Logged in as <span id="userId"></span></div>
      <button onclick="logout()">Logout</button>
    </div>
    <hr>
    <h3>Trending Foods</h3>
    <div id="trending">Loading...</div>
    <h3 style="margin-top:18px;">Feedback Analytics</h3>
    <div id="analytics">Loading...</div>
    <h3 style="margin-top:18px;">Suggest to Community</h3>
    <input id="suggestInput" placeholder="Suggest dish or restaurant"/>
    <button onclick="suggest()">Submit</button>
    <div id="suggestMsg" class="small"></div>
  </div>

  <div class="panel chat-panel">
    <h2>Chat & Recommendations</h2>
    <div id="chatBox"></div>
    <div style="display:flex; gap:10px; margin-top:10px;">
      <input id="chatInput" placeholder="Type your message..."/>
      <button onclick="sendChat()">Send</button>
    </div>
    <div id="feedbackRow" class="feedback-row" style="display:none;">
      <span>Did you like this recommendation?</span>
      <button onclick="sendFeedback('like')">Yes</button>
      <button onclick="enableDislike()">No</button>
      <textarea id="fbComment" placeholder="What was wrong?" style="display:none;"></textarea>
      <button id="fbSubmit" style="display:none;" onclick="submitDislike()">Submit</button>
      <div id="fbMsg" class="small"></div>
    </div>
  </div>
</div>
<script>
let token=null, currentUser=null;
let lastFoodId=null, lastRestaurantId=null;

function api(path, method='GET', body=null){
  return fetch("http://localhost:8000"+path,{
    method,
    headers:{
      "Content-Type":"application/json",
      ...(token?{"Authorization":"Bearer "+token}:{})
    },
    body: body?JSON.stringify(body):null
  }).then(r=>r.json());
}

function signup(){
  let email=document.getElementById('email').value.trim();
  let pwd=document.getElementById('pwd').value.trim();
  api("/api/signup","POST",{email,password:pwd}).then(d=>{
    document.getElementById('authMsg').innerText=d.success?"Signup ok. Login now.":(d.message||"Failed");
  });
}
function login(){
  let email=document.getElementById('email').value.trim();
  let pwd=document.getElementById('pwd').value.trim();
  api("/api/login","POST",{email,password:pwd}).then(d=>{
    if(d.success){
      token=d.token;currentUser=d.user_id;
      document.getElementById('userId').innerText=currentUser;
      document.getElementById('authBox').style.display='none';
      document.getElementById('profileBox').style.display='block';
      addMsg('bot',"Welcome! Ask for a dish or preference.");
      loadAnalytics();
    } else {
      document.getElementById('authMsg').innerText=d.message||"Login failed";
    }
  });
}
function logout(){
  token=null;currentUser=null;
  document.getElementById('authBox').style.display='block';
  document.getElementById('profileBox').style.display='none';
  document.getElementById('chatBox').innerHTML='';
  addMsg('bot',"Logged out.");
}
function addMsg(role,text){
  let box=document.getElementById('chatBox');
  let div=document.createElement('div');
  div.className='msg '+role;
  div.innerText=text;
  box.appendChild(div);
  box.scrollTop=box.scrollHeight;
}
function sendChat(){
  let txt=document.getElementById('chatInput').value.trim();
  if(!txt){return;}
  if(!currentUser){addMsg('bot','Please login first.');return;}
  addMsg('user',txt);
  document.getElementById('chatInput').value='';
  api("/api/chat","POST",{user_id:currentUser,session_id:currentUser+"_session",message:txt}).then(d=>{
    addMsg('bot',d.reply||"No reply.");
    if(d.request_feedback){
      lastFoodId=d.food_id;
      lastRestaurantId=d.restaurant_id;
      document.getElementById('feedbackRow').style.display='block';
      document.getElementById('fbComment').style.display='none';
      document.getElementById('fbSubmit').style.display='none';
      document.getElementById('fbMsg').innerText='';
    } else {
      document.getElementById('feedbackRow').style.display='none';
    }
  });
}
function sendFeedback(action){
  api("/api/feedback","POST",{user_id:currentUser,action,food_id:lastFoodId,restaurant_id:lastRestaurantId}).then(()=>{
    document.getElementById('fbMsg').innerText="Thanks for your feedback!";
    document.getElementById('feedbackRow').style.display='none';
  });
}
function enableDislike(){
  document.getElementById('fbComment').style.display='block';
  document.getElementById('fbSubmit').style.display='inline-block';
}
function submitDislike(){
  let comment=document.getElementById('fbComment').value.trim();
  api("/api/feedback","POST",{user_id:currentUser,action:"dislike",comment,food_id:lastFoodId,restaurant_id:lastRestaurantId}).then(()=>{
    document.getElementById('fbMsg').innerText="Appreciate your feedback!";
    document.getElementById('feedbackRow').style.display='none';
  });
}
function suggest(){
  let s=document.getElementById('suggestInput').value.trim();
  if(!currentUser){document.getElementById('suggestMsg').innerText="Login first";return;}
  if(!s){return;}
  api("/api/community_suggest","POST",{user_id:currentUser,suggestion:s}).then(d=>{
    document.getElementById('suggestMsg').innerText=d.success?"Submitted.":"Error.";
  });
}
function loadAnalytics(){
  api("/api/analytics/trending").then(data=>{
    document.getElementById('trending').innerHTML=(data||[]).map(f=>'<div>'+f.food_name+'</div>').join('')||'No data';
  });
  api("/api/feedback/analytics").then(d=>{
    document.getElementById('analytics').innerHTML="üëç "+(d.like_total||0)+" | üëé "+(d.dislike_total||0);
  });
}
window.onload=loadAnalytics;
</script>
</body>
</html>